# 趋势跟踪量化策略

## 项目概述

这是一个基于多因子选股的趋势跟踪量化策略，采用动态权重分配和风险管理，旨在在控制回撤的同时追求稳定收益。

## 核心特性

### 多因子选股
- **动量因子**: 多窗口动量分析，捕捉不同时间尺度的趋势
- **波动率因子**: 基于历史波动率的风险调整
- **情绪因子**: 市场情绪分析（需配合score_engine模块）
- **估值因子**: 基本面估值分析
- **趋势因子**: 技术趋势判断
- **反转因子**: 短期反转机会捕捉
- **波动收缩突破**: 波动率收缩后的突破机会

### 动态权重调整
- 基于因子IC（信息系数）的实时权重更新
- 每月自动调整因子权重，适应市场变化
- 最小权重保护机制，确保因子多样性

### 多层次风险管理
- **组合层面**: 最大回撤控制、波动率目标控制
- **个股层面**: ATR动态止损、浮盈回撤止盈
- **市场层面**: 基于VIX和SPY趋势的风险调整
- **实时监控**: 夏普比率、波动率、回撤等指标实时计算

### 智能资产配置
- **行业分散**: 确保至少3个行业，最多5个行业
- **市值分散**: 大中小市值股票均衡配置
- **相关性约束**: 动态相关性阈值，避免过度集中
- **安全资产**: 市场风险时自动增加SHV配置

### 回测结果分析
- **自动保存**: 每次回测自动保存结果到JSON文件
- **批量对比**: 支持多组回测结果的批量对比分析
- **可视化报告**: 自动生成图表和统计报告
- **Excel导出**: 一键导出详细对比数据到Excel

## 文件结构

```
TrendFollowStrategy/
├── main.py                 # 主策略文件
├── score_engine.py         # 情绪和估值因子引擎
├── trendCalculator.py      # 趋势计算模块
├── rolling_backtest.py     # 滚动窗口回测工具
├── market_analysis.py      # 市场环境分析工具
├── backtest_analyzer.py    # 回测结果分析工具
├── backtest_results/       # 回测结果存储目录
└── README.md              # 项目说明文档
```

## 快速开始

### 1. 环境准备
确保已安装以下依赖：
```bash
pip install numpy pandas scipy scikit-learn matplotlib seaborn openpyxl
```

### 2. 运行策略
在QuantConnect平台：
1. 上传 `main.py` 文件
2. 设置回测参数（可选）
3. 点击运行回测
4. 回测完成后结果自动保存

### 3. 参数调整
主要参数说明：
```python
# 基础参数
'final_universe_size': 30,        # 股票池大小
'max_drawdown_threshold': 0.08,   # 最大回撤阈值
'rebalance_interval_days': 30,    # 调仓周期

# 风控参数
'sharpe_threshold': 0.5,          # 夏普比率阈值
'volatility_threshold': 0.15,     # 波动率阈值
'max_drawdown_risk_threshold': 0.10  # 风险回撤阈值
```

## 高级功能

### 滚动窗口回测
```bash
python rolling_backtest.py
```
- 自动生成多个时间窗口
- 支持蒙特卡洛参数扰动
- 批量回测结果汇总
- **自动分析**: 回测完成后自动生成对比报告

### 市场环境分析
```bash
python market_analysis.py
```
- 牛市、熊市、震荡市表现分析
- 策略鲁棒性评分
- 自动生成优化建议

### 回测结果分析
```bash
python backtest_analyzer.py
```
- 加载所有历史回测结果
- 生成详细的对比分析报告
- 创建可视化图表
- 导出Excel格式的详细数据

#### 分析功能包括：
- **对比表格**: 所有回测结果的关键指标对比
- **统计分析**: 平均值、标准差、最佳/最差表现
- **可视化图表**: 
  - 收益率分布直方图
  - 风险收益散点图
  - 收益率时间序列
  - 关键指标箱线图
- **最佳表现**: 自动识别表现最好的回测
- **Excel导出**: 详细数据和汇总统计

## 使用流程

### 单次回测
1. 运行策略 → 结果自动保存
2. 运行分析器查看结果

### 批量回测
1. 运行 `rolling_backtest.py` → 自动批量回测
2. 回测完成后自动生成分析报告
3. 查看 `backtest_results/` 目录下的结果

### 历史结果分析
1. 运行 `backtest_analyzer.py`
2. 查看控制台输出的分析报告
3. 查看生成的图表和Excel文件

## 性能指标

基于历史回测结果：
- **年化收益率**: ~15%
- **夏普比率**: ~1.2
- **最大回撤**: <8%
- **胜率**: ~65%

## 风险提示

1. **历史表现不代表未来收益**
2. **建议充分回测验证后再实盘使用**
3. **定期监控风险指标，及时调整参数**
4. **市场环境变化可能影响策略表现**

## 优化建议

### 参数优化
- 使用 `rolling_backtest.py` 进行参数敏感性分析
- 根据市场环境调整风控参数
- 定期重新训练因子权重

### 因子增强
- 可添加新的技术指标因子
- 考虑宏观经济因子
- 优化情绪和估值因子计算

### 风控改进
- 增加VaR控制
- 考虑极端市场情况
- 优化止损止盈逻辑

## 技术支持

如有问题或建议，请：
1. 检查参数设置是否正确
2. 查看日志输出，定位问题
3. 运行市场环境分析，评估策略适应性
4. 使用回测分析器对比历史表现

## 更新日志

### v2.1 (2024)
- 新增回测结果分析工具
- 自动保存回测结果
- 批量对比分析功能
- 可视化报告生成

### v2.0 (2024)
- 新增风险指标监控
- 优化行业分散逻辑
- 增加市场环境分析工具
- 完善代码注释和文档

### v1.0 (2023)
- 基础多因子策略实现
- 动态权重调整
- 基础风险管理

---

**免责声明**: 本策略仅供学习和研究使用，不构成投资建议。投资有风险，入市需谨慎。 